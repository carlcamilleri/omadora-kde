#!/bin/bash
# Helper script to detect and fix WM_CLASS for webapps

if [ "$#" -lt 1 ]; then
  echo "Usage: omadora-webapp-fix-class <webapp-name>"
  echo "Example: omadora-webapp-fix-class Teams"
  exit 1
fi

APP_NAME="$1"
DESKTOP_FILE="$HOME/.local/share/applications/$APP_NAME.desktop"

if [ ! -f "$DESKTOP_FILE" ]; then
  echo "Error: Desktop file not found: $DESKTOP_FILE"
  exit 1
fi

echo "Detecting display server..."
echo ""

# Detect if we're on Wayland or X11
if [ -n "$WAYLAND_DISPLAY" ]; then
  # Check for various qdbus command names
  if command -v qdbus6 &>/dev/null; then
    QDBUS_CMD="qdbus6"
  elif command -v qdbus-qt6 &>/dev/null; then
    QDBUS_CMD="qdbus-qt6"
  elif command -v qdbus &>/dev/null; then
    QDBUS_CMD="qdbus"
  elif command -v busctl &>/dev/null; then
    # Use busctl as fallback (part of systemd)
    echo "Running on Wayland - using busctl to detect window class"
    echo ""
    echo "Querying KWin for window information..."
    echo ""

    # Use busctl to call KWin's D-Bus interface
    WINDOW_INFO=$(busctl --user call org.kde.KWin /KWin org.kde.KWin.queryWindowInfo 2>/dev/null)

    if [ -z "$WINDOW_INFO" ]; then
      echo "Error: Could not query KWin. Manual entry required."
      echo ""
      read -p "Enter the WM_CLASS for your webapp (check window properties): " WM_CLASS
    else
      # Parse the busctl output
      echo "Available windows:"
      echo "$WINDOW_INFO" | grep -o 'resourceClass[^}]*' | sed 's/resourceClass.*: "\([^"]*\)".*/\1/' | nl
      echo ""
      read -p "Enter the resourceClass value for your webapp: " WM_CLASS
    fi
  else
    echo "Error: No D-Bus tool found. Manual entry required."
    echo ""
    echo "To find the WM_CLASS manually:"
    echo "1. Open System Settings > Window Management > Window Rules"
    echo "2. Click 'Detect Window Properties'"
    echo "3. Click on your webapp window"
    echo "4. Look for 'Window class (application)' value"
    echo ""
    read -p "Enter the WM_CLASS for your webapp: " WM_CLASS
  fi

  # If we have a qdbus command, use it
  if [ -n "$QDBUS_CMD" ]; then
    echo "Running on Wayland - using $QDBUS_CMD to detect window class"
    echo ""
    echo "Step 1: Make sure the webapp '$APP_NAME' is open and visible"
    echo "Step 2: The script will search for windows matching the app name"
    read -p "Press Enter when ready..."

    # Try to find the window using KWin's scripting interface
    # Get list of all windows and their classes
    WM_CLASS=$($QDBUS_CMD org.kde.KWin /KWin org.kde.KWin.queryWindowInfo | grep -i "$APP_NAME" -A 5 | grep "resourceClass:" | head -1 | cut -d: -f2 | tr -d ' ')

    if [ -z "$WM_CLASS" ]; then
      # Fallback: list all windows and let user identify
      echo ""
      echo "Could not auto-detect. Here are all open windows:"
      echo ""
      $QDBUS_CMD org.kde.KWin /KWin org.kde.KWin.queryWindowInfo | grep -E "(caption:|resourceClass:)" | sed 'N;s/\n/ - /'
      echo ""
      read -p "Enter the resourceClass value for your webapp: " WM_CLASS
    fi
  fi
else
  echo "Running on X11 - using xprop to detect window class"
  echo ""
  echo "Step 1: Make sure the webapp '$APP_NAME' is open and visible"
  echo "Step 2: Click on the webapp window when the crosshair appears"
  read -p "Press Enter when ready..."

  # Get the WM_CLASS of the selected window
  echo ""
  echo "Click on the $APP_NAME window..."
  WM_CLASS_OUTPUT=$(xprop WM_CLASS 2>/dev/null)

  if [ $? -ne 0 ]; then
    echo "Error: Failed to get WM_CLASS. Make sure xprop is installed."
    exit 1
  fi

  # Extract the second class name (the one after the comma)
  # WM_CLASS output looks like: WM_CLASS(STRING) = "instance", "class"
  WM_CLASS=$(echo "$WM_CLASS_OUTPUT" | sed 's/.*= "\([^"]*\)", "\([^"]*\)".*/\2/')
fi

if [ -z "$WM_CLASS" ]; then
  echo "Error: Could not extract WM_CLASS from: $WM_CLASS_OUTPUT"
  exit 1
fi

echo ""
echo "Detected WM_CLASS: $WM_CLASS"
echo ""

# Check if StartupWMClass already exists in the desktop file
if grep -q "^StartupWMClass=" "$DESKTOP_FILE"; then
  CURRENT_CLASS=$(grep "^StartupWMClass=" "$DESKTOP_FILE" | cut -d'=' -f2)
  echo "Current StartupWMClass: $CURRENT_CLASS"

  if [ "$CURRENT_CLASS" = "$WM_CLASS" ]; then
    echo "StartupWMClass is already correct!"
    exit 0
  fi

  # Update existing StartupWMClass
  sed -i "s/^StartupWMClass=.*/StartupWMClass=$WM_CLASS/" "$DESKTOP_FILE"
  echo "Updated StartupWMClass from '$CURRENT_CLASS' to '$WM_CLASS'"
else
  # Add StartupWMClass after Icon line
  sed -i "/^Icon=/a StartupWMClass=$WM_CLASS" "$DESKTOP_FILE"
  echo "Added StartupWMClass=$WM_CLASS to desktop file"
fi

# Update KDE's application cache
if command -v kbuildsycoca6 &>/dev/null; then
  kbuildsycoca6 &>/dev/null
elif command -v kbuildsycoca5 &>/dev/null; then
  kbuildsycoca5 &>/dev/null
fi

echo ""
echo "âœ“ Desktop file updated successfully!"
echo "Close and restart the webapp for the icon to update."
