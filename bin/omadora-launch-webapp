#!/bin/bash
# Launch the passed in URL as a web app in the default browser (or chromium if the default doesn't support --app).

browser=$(xdg-settings get default-web-browser 2>/dev/null)

# If no default browser or browser doesn't support --app, try common browsers
case $browser in
google-chrome* | brave-browser* | microsoft-edge* | opera* | vivaldi* | chromium*)
  # Browser supports --app mode
  ;;
*)
  # Fallback to chromium or find first available browser that supports --app
  if command -v chromium &>/dev/null; then
    browser="chromium.desktop"
  elif command -v chromium-browser &>/dev/null; then
    browser="chromium-browser.desktop"
  elif command -v brave &>/dev/null; then
    browser="brave-browser.desktop"
  elif command -v google-chrome &>/dev/null; then
    browser="google-chrome.desktop"
  else
    # No supported browser found, just open in default browser normally
    exec xdg-open "$1"
    exit 0
  fi
  ;;
esac

# Find the browser executable from .desktop file
browser_exec=$(find ~/.local/share/applications ~/.nix-profile/share/applications /usr/share/applications -name "$browser" 2>/dev/null | head -1 | xargs grep -m1 "^Exec=" | sed 's/^Exec=\([^ ]*\).*/\1/')

# If we found the browser, launch it in app mode
if [ -n "$browser_exec" ]; then
  exec setsid "$browser_exec" --app="$1" "${@:2}" &>/dev/null &
else
  # Fallback to xdg-open
  exec xdg-open "$1"
fi
