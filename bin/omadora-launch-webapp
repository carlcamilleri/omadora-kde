#!/bin/bash
# Launch the passed in URL as a web app in the default browser (or chromium if the default doesn't support --app).

URL="$1"
WINDOW_CLASS="${2:-WebApp}"  # Optional window class for proper icon association

browser=$(xdg-settings get default-web-browser 2>/dev/null)

# If no default browser or browser doesn't support --app, try common browsers
case $browser in
google-chrome* | brave-browser* | com.brave.Browser* | microsoft-edge* | opera* | vivaldi* | chromium*)
  # Browser supports --app mode
  ;;
*)
  # Fallback to chromium or find first available browser that supports --app
  if command -v chromium &>/dev/null; then
    browser="chromium.desktop"
  elif command -v chromium-browser &>/dev/null; then
    browser="chromium-browser.desktop"
  elif command -v brave &>/dev/null; then
    browser="brave-browser.desktop"
  elif command -v google-chrome &>/dev/null; then
    browser="google-chrome.desktop"
  else
    # No supported browser found, just open in default browser normally
    exec xdg-open "$URL"
    exit 0
  fi
  ;;
esac

# Find the browser executable from .desktop file
desktop_file=$(find ~/.local/share/applications \
  ~/.local/share/flatpak/exports/share/applications \
  /var/lib/flatpak/exports/share/applications \
  ~/.nix-profile/share/applications \
  /usr/share/applications \
  -name "$browser" 2>/dev/null | head -1)

if [ -n "$desktop_file" ]; then
  # Extract the full Exec line and remove field codes (%u, %U, %f, %F, etc.)
  browser_exec=$(grep -m1 "^Exec=" "$desktop_file" | sed 's/^Exec=//' | sed 's/%[uUfF]$//' | sed 's/ *$//')

  # Launch with --app flag and custom window class for proper icon association
  exec setsid bash -c "$browser_exec --class=\"$WINDOW_CLASS\" --app=\"$URL\"" &>/dev/null &
else
  # Fallback to xdg-open
  exec xdg-open "$URL"
fi
